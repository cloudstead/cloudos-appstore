#
# Cookbook Name:: {{app.name}}
# Recipe:: default
#
# {{app.publisher.packaging_copyright}}
#

{{#if app.repo}}
include_recipe 'git::default'
{{/if}}

{{#if app.web}}
include_recipe '{{app.web.type}}::default'
{{/if}}

{{#if app.database}}
include_recipe '{{app.database.type}}::default'
{{/if}}

require 'securerandom'

base = Chef::Recipe::Base
app_lib = Chef::Recipe::{{app.chefName}}

# Install any certs provided
base.local_certs('{{app.name}}').each do |cert_name|
  base.install_ssl_cert self, '{{app.name}}', cert_name
  Chef::Recipe::Java.install_cert(self, cert_name, base.pem_path(cert_name)) if defined? Chef::Recipe::Java.install_cert
end

app = app_lib.define_app self

{{#if app.pre_package}}
  {{#each app.pre_package}}
      app_lib.exec self, app, '{{safe exec}}', '{{user}}', '{{safe dir}}', '{{safe stdin}}', '{{safe unless}}'
  {{/each}}
{{/if}}

{{#if app.packages}}
  {{#each app.packages}}
package '{{this}}' do
  action :install
end
  {{/each}}
{{/if}}

{{#if app.post_package}}
    {{#each app.post_package}}
        app_lib.exec self, app, '{{safe exec}}', '{{user}}', '{{safe dir}}', '{{safe stdin}}', '{{safe unless}}'
    {{/each}}
{{/if}}

# init and init_{{app.style}} (a few lines down) are defined in libraries/{{app.style}}_lib.rb
app_lib.init self, app

{{#if app.users}}
    {{#each app.users}}
        {{#if kerberos}}
raise "cannot create kerberos user without kerberos library." unless defined? Chef::Recipe::Kerberos.create_user
kerberos_password = app[:users]['{{label}}'][:password] = base.password('{{user}}')
Chef::Recipe::Kerberos.create_user self, '{{user}}', kerberos_password

        {{else}}
app_lib.user self, app, '{{user}}', {{quoted_or_nil home}}, {{quoted_or_nil group}}, {{can_login}}, {{system}}
        {{/if}}
    {{/each}}
{{/if}}

{{#if app.groups}}
    app[:groups] = {}
    {{#each app.groups}}

        app[:groups]['{{label}}'] = {
          :name => '{{group}}'
        }

        {{#if members}}
            members = []
            {{#each members}}
                members << app_lib.subst_string('{{this}}', app)
            {{/each}}
            app[:groups]['{{label}}'][:members] = members
        {{else}}
            members = nil
        {{/if}}
        app_lib.define_group self, app, '{{group}}', members
    {{/each}}
{{/if}}

{{#if app.tarball}}
app_lib.install_tarball self, app
{{/if}}

{{#if app.repo}}
app_lib.install_git self, app
{{/if}}

{{#if app.database}}
# database-related configuration is in libraries/database_lib.rb and libraries/database_{{app.style}}_lib.rb
app_lib.database_{{app.style}}_packages self, app if defined? app_lib.database_{{app.style}}_packages
{{/if}}

{{#if app.prep_code}}
    {{#each app.prep_code}}
app_lib.exec self, app, '{{safe exec}}', '{{user}}', '{{safe dir}}', '{{safe stdin}}', '{{safe unless}}'
    {{/each}}
{{/if}}

app_lib.init_{{app.style}} self, app if defined? app_lib.init_{{app.style}}

{{#if app.dirs}}
    {{#each app.dirs}}
        app_lib.dir self, '{{this}}', app
    {{/each}}
{{/if}}

{{#if app.templates}}
    {{#each app.templates}}
app_lib.template_file self, '{{this}}', '{{@key}}', app
    {{/each}}
{{/if}}

{{#if app.database}}
app_lib.database self, app
{{/if}}

{{#if app.web}}
app_lib.{{app.web.type}} self, app
{{/if}}

{{#if app.copy}}
    {{#each app.copy}}
app_lib.copy self, '{{this}}', '{{@key}}', app
    {{/each}}
{{/if}}

{{#if app.move}}
    {{#each app.move}}
app_lib.move self, '{{this}}', '{{@key}}', app
    {{/each}}
{{/if}}

{{#if app.symlinks}}
    {{#each app.symlinks}}
app_lib.symlink self, '{{this}}', '{{@key}}', app
    {{/each}}
{{/if}}

{{#if app.perms}}
  {{#each app.perms}}
app_lib.permission self, '{{@key}}', app, {{quoted_or_nil chown}}, {{quoted_or_nil chgrp}}, {{quoted_or_nil perms}}, {{recursive}}
  {{/each}}
{{/if}}

{{#if app.append}}
    {{#each app.append}}
app_lib.append self, '{{safe this}}', '{{@key}}', app
    {{/each}}
{{/if}}

{{#if app.mailboxes}}
raise "Cannot create mailboxes, standard email_lib not found" unless defined? Chef::Recipe::Email.create_mailbox

email_lib = Chef::Recipe::Email
  {{#each app.mailboxes}}
email_lib.create_mailbox self, '{{address}}', app[:hostname], {{quoted_or_nil alias_for}}
  {{/each}}
{{/if}}

{{#if app.cloudos_groups}}
  {{#each app.cloudos_groups}}
app_lib.cloudos_group self, app, '{{@key}}', '{{safe description}}', '{{quota}}', '{{mirror}}', '{{members}}'
  {{/each}}
{{/if}}

{{#if app.auth.user_management}}
app_lib.user_management self, app
{{/if}}

{{#if app.post_install}}
    {{#each app.post_install}}
app_lib.exec self, app, '{{safe exec}}', '{{user}}', '{{safe dir}}', '{{safe stdin}}', '{{safe unless}}'
    {{/each}}
{{/if}}

# ensure doc root is owned by / readable by apache user
app_lib.permission(self, '@doc_root', app, nil, nil, '-R u+rx') if app[:doc_root]

# ensure doc root base world readable/listable
app_lib.permission(self, '@doc_root', app, nil, nil, 'a+rx') if app[:doc_root]

{{#if app.logrotate}}
    {{#each app.logrotate}}
app_lib.logrotate self, app, '{{this}}'
    {{/each}}
{{/if}}

{{#if app.sysinit}}
    {{#each app.sysinit}}
app_lib.sysinit self, app, '{{this}}'
    {{/each}}
{{/if}}

{{#if app.services}}
    {{#each app.services}}
        {{#if chefProvider}}
app_lib.service self, app, '{{name}}', '{{safe pattern}}', {{chefProvider}}
        {{else}}
app_lib.service self, app, '{{name}}', '{{safe pattern}}'
        {{/if}}
    {{/each}}
{{/if}}

{{#if app.web}}
app_lib.{{app.web.type}}_reload self
{{/if}}
