#!/bin/bash
#
# The Bundler. Creates a CloudOs app bundle from a manifest file.
#
# The directory provided must contain a cloudos-manifest.json file that defines the app.
# The resulting bundle will be written to target/appname-bundle.tar.gz within the directory.
#
# Usage:
#
#   cbundle_app [debug [<port>]] path/to/app/dir
#
# To attach a debugger to the bundler, supply 'debug' as the first argument, optionally followed by a port number.
# The default debug port is 5005
#
# To override the location of the bundler jar file, set the CLOUDOS_BUNDLER_JAR environment variable.
#

function die () {
  echo 1>&2 "${1}"
  exit 1
}

SCRIPT_BASE=$(cd $(dirname $0) && pwd)

debug="${1}"
if [ "x${debug}" = "xdebug" ] ; then
  shift
  ARG_LEN=$(echo -n "${1}" | wc -c)
  ARG_NUMERIC_LEN=$(echo -n "${1}" | tr -dc [:digit:] | wc -c)  # strip all non-digits
  if [ ${ARG_LEN} -eq ${ARG_NUMERIC_LEN} ] ; then
    # Second arg is the debug port
    DEBUG_PORT="${1}"
    shift
  else
    DEBUG_PORT=5005
  fi
  debug="-Xdebug -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=${DEBUG_PORT}"
else
  debug=""
fi

APP_BASE=${1}
if [ -z "${APP_BASE}" ] ; then
  die "No app dir specified"
fi

# If a pre_bundle.sh script is present, run it first
if [ -x ${APP_BASE}/pre_bundle.sh ] ; then
  ${APP_BASE}/pre_bundle.sh || die "Error running ${APP_BASE}/pre_bundle.sh"
fi

if [ ! -f ${APP_BASE}/cloudos-manifest.json ] ; then
  die "No cloudos-manifest.json found in ${APP_BASE}, skipping"
fi

APP_BASE=$(cd ${APP_BASE} && pwd)

APP=$(basename ${APP_BASE})
TARGET=${APP_BASE}/target
BUNDLE_DIR=${TARGET}/${APP}-bundle
TARBALL=${TARGET}/${APP}-bundle.tar.gz

# cleanup any previous bundling and start fresh
rm -rf ${BUNDLE_DIR}
rm -rf ${TARBALL}
mkdir -p ${BUNDLE_DIR}

# Find bundler jar.
BUNDLER_JAR="not-found"
if [ ! -z "${CLOUDOS_BUNDLER_JAR}" ] ; then
  if [ -r "${CLOUDOS_BUNDLER_JAR}" ] ; then
    BUNDLER_JAR="${CLOUDOS_BUNDLER_JAR}"
  else
    die "CLOUDOS_BUNDLER_JAR env var was set, but doesn't seem to be valid: ${CLOUDOS_BUNDLER_JAR}"
  fi

elif [ -f ${SCRIPT_BASE}/../packages/cloudos-app-bundler.jar ] ; then
  BUNDLER_JAR="${SCRIPT_BASE}/../packages/cloudos-app-bundler.jar"

elif [ -f ${SCRIPT_BASE}/../appstore-common/pom.xml ] ; then
  # Run from cloudos-appstore/bin, use maven directly
  BUNDLER_JAR="use-maven"
fi

# Run bundler
BUNDLER_OPTS="-m ${APP_BASE}/cloudos-manifest.json -o ${BUNDLE_DIR}"
case "${BUNDLER_JAR}" in
  not-found)
    die "Bundler jar could not be located"
  ;;

  use-maven)
    echo 1>&2 "Running maven bundler with options: ${BUNDLER_OPTS}"
    cd ${SCRIPT_BASE}/../appstore-common && \
    MAVEN_OPTS="${debug} ${MAVEN_OPTS}" mvn exec:java \
      -Dexec.mainClass=cloudos.appstore.bundler.BundlerMain \
      -Dexec.args="${BUNDLER_OPTS}" \
      1>&2
    if [ $? -ne 0 ] ; then
      die "Error running bundler on ${APP_BASE}"
    fi
  ;;

  *)
    # we have a jar file, use it
    echo 1>&2 "Running jar bundler with options: ${BUNDLER_OPTS}"
    java ${debug} -jar ${BUNDLER_JAR} ${BUNDLER_OPTS}
  ;;
esac

# make the tarball
cd ${BUNDLE_DIR} && tar czf ${TARBALL} . || die "Error building tarball"

echo 1>&2 "Successfully built tarball for ${APP} from ${BUNDLE_DIR}: ${TARBALL}"
echo ${TARBALL}
