#!/bin/bash
#
# Update an app on a live cloudstead
#
# Usage: patch_app <app> <cs-name>
#
# app     : a path to a directory containing a cloudos-manifest.json file
# cs-name : name of the cloudstead: the first portion of the hostname of the instance.
#
# The domain name is read from the CS_DOMAIN env var, and defaults to cloudstead.io
#

app="${1}"
name="${2}"

if [[ -z "${app}" || -z "${name}" ]] ; then
  echo "Usage: $0 <app> <name>"
  exit 1
fi

if [ ! -d ${app} ] ; then
  echo "Not a directory: ${app}"
  exit 1
fi

if [ ! -f ${app}/cloudos-manifest.json ] ; then
  echo "No cloudos-manifest.json file found in ${app}"
  exit 1
fi

if [ -z "${CS_DOMAIN}" ] ; then
  CS_DOMAIN="cloudstead.io"
fi

script_dir=$(cd $(dirname ${0}) && pwd)
app_name=$(basename ${app})

cd ${app} && \
rm -rf ./target/ && \
${script_dir}/cbundle_app $(pwd) && \
rsync -avzc ./target/${app_name}-bundle/chef/cookbooks/* \
             ${name}@${name}.${CS_DOMAIN}:chef/cookbooks/ && \
scp ./target/${app_name}-bundle/cloudos-manifest.json ${name}@${name}.${CS_DOMAIN}:chef/data_bags/${app_name}/
